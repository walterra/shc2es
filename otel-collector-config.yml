# EDOT Collector Configuration for Kibana APM UI
# See: https://www.elastic.co/docs/reference/opentelemetry/edot-collector
#
# Required components for APM UI:
# - elasticapm processor: enriches traces for APM UI compatibility
# - spanmetrics connector: generates APM metrics from traces

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:
    timeout: 5s
    send_batch_size: 1000

  # Required for Kibana APM UI - enriches traces with Elastic-specific attributes
  elasticapm: {}

connectors:
  # Required for Kibana APM UI - generates APM metrics from traces
  # (latency histograms, throughput, service maps)
  spanmetrics:

exporters:
  debug:
    verbosity: basic

  # Elasticsearch exporter with OTel-native mapping
  elasticsearch/otel:
    endpoints: ["${env:ES_NODE}"]
    api_key: ${env:ELASTIC_API_KEY}
    mapping:
      mode: otel  # Preserves OTel semantics (recommended for Stack 9.x)
    logs_dynamic_index:
      enabled: true
    metrics_dynamic_index:
      enabled: true
    traces_dynamic_index:
      enabled: true
    tls:
      insecure_skip_verify: true  # For self-signed certs in development

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch, elasticapm]
      exporters: [debug, spanmetrics, elasticsearch/otel]

    # Metrics pipeline receives both direct metrics AND generated APM metrics
    metrics:
      receivers: [otlp, spanmetrics]
      processors: [batch]
      exporters: [debug, elasticsearch/otel]

    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [debug, elasticsearch/otel]
